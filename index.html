<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Viewer</title>
</head>

<body>
<script type="module">
    /*
    import { openArray } from 'https://cdn.skypack.dev/zarr';

    import init, {testDeviceSharing, runVolumeExample, createCtxFromOffscreenCanvas} from "./pkg/volume_viewer.js";

    // returns first channel of lowest resolution from test data set on my local machine
    async function getRawZarrArray() {
        const store = document.getElementById('ome-zarr-store').value;
        const path = document.getElementById('ome-zarr-path').value

        const z = await openArray({
            store,
            path: `${path}/2`,
            mode: "r"
        });

        const raw = await z.getRaw([0, 0]);

        // configure z-slice slider
        document.getElementById('z-slice').max = raw.shape[0] - 1;

        return raw;
    }

    async function run() {
        // initialize wasm (including module specific initialization)
        await init();

        testDeviceSharing();

        const offscreenCanvas = new OffscreenCanvas(256, 256);
        await createCtxFromOffscreenCanvas(offscreenCanvas);

        const {data, shape} = await getRawZarrArray();
        await runVolumeExample(data, shape);
    }

    run();
    */
    import { sharedWorker } from "./loader-interface.js";
    import { sharedWorker2 } from "./offscreen_renderer.js";

    import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";

    import { toWrappedEvent } from "./event.js";

    async function start(canvasId) {
        const canvas = document.querySelector(canvasId);

        const hasOffscreenSupport = !!canvas.transferControlToOffscreen;
        if (hasOffscreenSupport) {
            const worker = new Worker("worker.js", { type: "module" });
            const obj = Comlink.wrap(worker);

            const offscreen = canvas.transferControlToOffscreen();
            offscreen.onmousedown = (e) => {
                console.log('onmousedown event listener in main', e);
            };
            offscreen.addEventListener('mousedown', (e) => {
                console.log('custom event listener in main', e);
            });
            Comlink.transfer(offscreen, [offscreen]);
            obj.initialize(offscreen);

            obj.run();

            const dispatchToWorker = (e) => {
                obj.dispatchCanvasEvent(JSON.stringify(toWrappedEvent(e)));
            }
            canvas.onmousedown = dispatchToWorker;
            canvas.onmouseup = dispatchToWorker;
            canvas.onmousemove = dispatchToWorker;
            canvas.onwheel = dispatchToWorker;
            window.onkeydown = dispatchToWorker;
            window.onkeyup = dispatchToWorker;
            window.onkeypress = dispatchToWorker;

        } else {
            console.warn(`Canvas with id "${canvasId}" does not support offscreen rendering.`);
        }
    }
    start('canvas');
</script>

<div>
    <div>
        <label for="ome-zarr-store">OME-Zarr file store:</label>
        <input type="text" id="ome-zarr-store" name="ome-zarr-store" value="http://localhost:8005/"><br><br>
    </div>
    <div>
        <label for="ome-zarr-path">OME-Zarr file path:</label>
        <input type="text" id="ome-zarr-path" name="ome-zarr-path" value="ome-zarr/m.ome.zarr/0"><br><br>
    </div>

    <canvas id="existing-canvas" width="800" height="600" oncontextmenu="return false;" ></canvas>
    <canvas id="canvas" width="800" height="600"></canvas>

    <div hidden>
        <label for="z-slice">Z Slice:</label>
        <input type="range" id="z-slice" name="z-slice" min="0" max="0">
    </div>

</div>
</body>
</html>