<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Viewer</title>
</head>

<body>
<script type="module">
    /*
    import { openArray } from 'https://cdn.skypack.dev/zarr';

    import init, {testDeviceSharing, runVolumeExample, createCtxFromOffscreenCanvas} from "./pkg/volume_viewer.js";

    // returns first channel of lowest resolution from test data set on my local machine
    async function getRawZarrArray() {
        const store = document.getElementById('ome-zarr-store').value;
        const path = document.getElementById('ome-zarr-path').value

        const z = await openArray({
            store,
            path: `${path}/2`,
            mode: "r"
        });

        const raw = await z.getRaw([0, 0]);

        // configure z-slice slider
        document.getElementById('z-slice').max = raw.shape[0] - 1;

        return raw;
    }

    async function run() {
        // initialize wasm (including module specific initialization)
        await init();

        testDeviceSharing();

        const offscreenCanvas = new OffscreenCanvas(256, 256);
        await createCtxFromOffscreenCanvas(offscreenCanvas);

        const {data, shape} = await getRawZarrArray();
        await runVolumeExample(data, shape);
    }

    run();
    */
    import { sharedWorker } from "./loader-interface.js";
    import { sharedWorker2 } from "./offscreen_renderer.js";


    import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";

    async function start() {
        await sharedWorker();
        //await sharedWorker2();

        const canvas = document.querySelector('canvas');

        const hasOffscreenSupport = !!canvas.transferControlToOffscreen;
        console.log(`hasOffscreenSupport: ${hasOffscreenSupport}`);
        const offscreen = canvas.transferControlToOffscreen();

        //const worker = new Worker('myworkerurl.js');
        //worker.postMessage({canvas: offscreen}, [offscreen]);
        //const worker = new SharedWorker("worker.js", { type: "module" });
        //const obj = Comlink.wrap(worker.port);

        const worker = new Worker("worker.js", { type: "module" });
        // WebWorkers use `postMessage` and therefore work with Comlink.
        const obj = Comlink.wrap(worker);

        Comlink.transfer(offscreen, [offscreen]);
        console.log('hello');
        console.log(await obj.counter);
        console.log('what');
        await obj.inc();
        console.log('what');
        console.log(await obj.counter);
        const instance = await navigator.gpu.requestAdapter({ powerPreference: "high-performance" });
        console.log(" dsfadsfasdfasdfasdfaav", navigator, instance);

        await obj.run(offscreen, null);
    }
    start();
</script>

<div>
    <div>
        <label for="ome-zarr-store">OME-Zarr file store:</label>
        <input type="text" id="ome-zarr-store" name="ome-zarr-store" value="http://localhost:8005/"><br><br>
    </div>
    <div>
        <label for="ome-zarr-path">OME-Zarr file path:</label>
        <input type="text" id="ome-zarr-path" name="ome-zarr-path" value="ome-zarr/m.ome.zarr/0"><br><br>
    </div>

    <canvas id="existing-canvas" width="800" height="600" oncontextmenu="return false;" ></canvas>
    <canvas id="canvas" width="800" height="600"></canvas>

    <div hidden>
        <label for="z-slice">Z Slice:</label>
        <input type="range" id="z-slice" name="z-slice" min="0" max="0">
    </div>

</div>
</body>
</html>