<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Viewer</title>
</head>
<body style="background-color:rgb(51, 51, 51);">

<!-- Adds COOP and COEP headers, see: https://github.com/gzuidhof/coi-serviceworker -->
<script src="coi-serviceworker.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js"></script>
<script type="module">
    import { createOffscreenRenderer, Config } from './js/src/offscreen_renderer.js';
    import { ChannelSettings, VolumeRendererSettings, RENDER_MODE_GRID_TRAVERSAL, RENDER_MODE_DIRECT } from './js/src/volume-renderer.js';
    import { VolumeDataSourceConfig, DataStoreConfig, BrickConfig, PreprocessConfig, PREPROCESS_METHOD_CAST } from "./js/src/volume-data-source.js";

    // todo: this should come from the user
    const dataSourceConfig = new VolumeDataSourceConfig(
        new DataStoreConfig({
            store: 'http://localhost:8005/',
            path: 'bonzai.zarr', //'stag_beetle.zarr',//'ome-zarr/m-128x128.ome.zarr/0',
        }),
        new PreprocessConfig({
            preprocessingMethod: PREPROCESS_METHOD_CAST,
            isZeroThreshold: 0.01,
        }),
        new BrickConfig({
            minSize: [32, 32, 32],
            maxSize: [256, 256, 256],
        }),
    );

    async function start() {
        try {
            const offscreenRenderer = await createOffscreenRenderer(new Config({
                canvas: {
                    canvasId: 'canvas'
                },
                logging: 'debug',
                dataSource: dataSourceConfig,
            }));

            const volumeMetaData = await offscreenRenderer.volumeMeta;
            const volumeRendererSettings = new VolumeRendererSettings({
                channelSettings: volumeMetaData.channels.map((_, channelIndex) => {
                    return new ChannelSettings({
                        channelIndex,
                        visible: channelIndex === 0,
                        minLoD: volumeMetaData.resolutions.length,
                    });
                })
            });

            // TODO: clean this up
            // can it do transfer functions?
            // maybe: https://github.com/tweakpane/plugin-essentials
            const settings = new Tweakpane.Pane({
                title: 'Settings',
                expanded: true,
            });

            // RENDER SETTINGS
            const renderParams = {
                stepSize: 5.0,
                threshold: 0.5,
                adjustForPadding: false,
                renderMode: 'grid_traversal',
                color: '#0000ff',
                background: '#333333'
            };

            // todo: remove old render settings
            // todo: adapt event handling
            // todo: pass render settings to renderer at run
            const renderSettings = settings.addFolder({
                title: 'Rendering',
                expanded: true,
            });
            const renderModeSelector = renderSettings.addInput(
                volumeRendererSettings, 'renderMode',
                {
                    options: {
                        'Grid Traversal': RENDER_MODE_GRID_TRAVERSAL,
                        Direct: RENDER_MODE_DIRECT,
                    }
                }
            );
            const stepsSlider = renderSettings.addInput(
                volumeRendererSettings, 'stepScale',
                {min: 0.5, max: 10.0, step: 0.2, label: 'Step spacing'}
            );
            const numStepsSlider = renderSettings.addInput(
                volumeRendererSettings, 'maxSteps',
                {min: 1, max: 1000, step: 1, label: 'Max. steps'}
            );
            const backgroundColorPicker = renderSettings.addInput(volumeRendererSettings, 'backgroundColor', {
                picker: 'inline',
                expanded: false,
            });
            backgroundColorPicker.on('change', e => {
                document.body.style.backgroundColor = e.value;
            });

            const channelsSettings = renderSettings.addFolder({
                title: 'Channel Settings',
                expanded: true,
            });
            volumeRendererSettings.channelSettings.forEach(c => {
                const channelSettings = channelsSettings.addFolder({
                    title: c.channelName,
                    expanded: c.visible,
                });
                console.log(c.color);
                const colorPicker = channelSettings.addInput(c, 'color', {
                    picker: 'inline',
                    expanded: c.visible,
                    color: {type: 'float'},
                });
                const maxLodSlider = channelSettings.addInput(c, 'maxLoD', {
                    label: 'Highest Level of Detail',
                    min: 0, max: c.minLoD, step: 1
                });
                const thresholdLowerSlider = channelSettings.addInput(c, 'thresholdLower', {
                    label: 'Threshold (lower)',
                    min: 0.0, max: 1.0, step: 0.01
                });
                const thresholdUpperSlider = channelSettings.addInput(c, 'thresholdUpper', {
                    label: 'Threshold (upper)',
                    min: 0.0, max: 1.0, step: 0.01
                });
                const visible = channelSettings.addInput(c, 'visible');
            });

            const thresholdSlider = renderSettings.addInput(
                renderParams, 'threshold',
                {min: 0.0, max: 1.0, step: 0.01}
            );
            const colorPicker = renderSettings.addInput(renderParams, 'color', {
                picker: 'inline',
                expanded: false,
            });

            // EXPORT SETTINGS
            const exportSettingsButton = settings.addButton({
                title: 'Export Settings',
            });
            exportSettingsButton.on('click', function() {
                const preset = settings.exportPreset();
                console.log(preset);
            })

            console.log('volume meta in main', volumeMetaData, volumeRendererSettings);
            offscreenRenderer.run(volumeRendererSettings);

            // register UI event listeners for render settings
            const dispatchRenderSettingsChange = (e) => {
                offscreenRenderer.dispatchUIEvent(JSON.stringify({
                    type: 'rendersettings',
                    setting: e.presetKey,
                    value: e.value,
                }));
            };

            stepsSlider.on('change', dispatchRenderSettingsChange);
            renderModeSelector.on('change', dispatchRenderSettingsChange);
            thresholdSlider.on('change', dispatchRenderSettingsChange);
            colorPicker.on('change', dispatchRenderSettingsChange);

        } catch (e) {
            console.error(e);
        }
    }
    start();
</script>

<div>
    <canvas id="canvas" width="800" height="600"></canvas>
</div>

</body>
</html>