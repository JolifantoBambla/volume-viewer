<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WGPU using WASM</title>
</head>

<body>
<script type="module">
    //import { openGroup, slice, openArray } from 'https://unpkg.com/zarr@0.5.1/zarr.mjs';
    // Import invidual classes and functions.
    import { openGroup, openArray, slice } from 'https://cdn.skypack.dev/zarr';

    // Main entry point (exports all codecs)
    import { Blosc } from 'https://cdn.skypack.dev/numcodecs';

    import { printGpuDeviceLimits } from "./shared-gpu.js";

    // todo: publish npm and/or deno package instead
    import init, {main, runComputeExample, testDeviceSharing, printZSlice, runVolumeExample} from "./pkg/volume_viewer.js";

    // todo:
    //  - read whole single channel in single resolution into a rust created arraybuffer
    //  - construct 3D texture from buffer
    //  - render volume into texture via compute
    async function testOmeZarrStuff() {
        const store = document.getElementById('ome-zarr-store').value;
        const path = document.getElementById('ome-zarr-path').value

        const omeZarrGroup = await openGroup(store, path);
        const omeZarrMetadata = await omeZarrGroup.attrs.asObject();

        let paths = ['0'];
        // Default axes used for v0.1 and v0.2.
        let labels = ['t', 'c', 'z', 'y', 'x'];
        if ('multiscales' in omeZarrMetadata) {
            const { datasets, axes } = omeZarrMetadata.multiscales[0];
            paths = datasets.map(d => d.path);
            if (axes) {
                labels = axes;
            }
        }
        console.log(labels);

        const data = paths.map(path => omeZarrGroup.getItem(path));
        const arr = {
            data: await Promise.all(data),
            rootAttrs: omeZarrMetadata,
            labels
        };
        console.log(arr);

        const z = await openArray({
            store,
            path: `${path}/2`,
            mode: "r"
        });

        const { data: rawData, _, shape } = await z.getRaw([0, 0]);

        const slider = document.getElementById('z-slice');
        slider.max = shape[0] - 1;

        await runVolumeExample(rawData, shape);
    }

    async function run() {
        // initialize wasm (including module specific initialization)
        await init();

        testDeviceSharing();

        await testOmeZarrStuff();

        //await runComputeExample();

        //main({canvas: '#existing-canvas'});
    }

    run();
</script>

<div>
    <div>
        <label for="ome-zarr-store">OME-Zarr file store:</label>
        <input type="text" id="ome-zarr-store" name="ome-zarr-store" value="http://localhost:8005/"><br><br>
    </div>
    <div>
        <label for="ome-zarr-path">OME-Zarr file path:</label>
        <input type="text" id="ome-zarr-path" name="ome-zarr-path" value="ome-zarr/m.ome.zarr/0"><br><br>
    </div>

    <b>above existing canvas</b>
    <canvas id="existing-canvas" width="600" height="600"></canvas>

    <div>
        <label for="z-slice">Z Slice:</label>
        <input type="range" id="z-slice" name="z-slice" min="0" max="0">
    </div>

    <b>below existing canvas</b>
</div>
</body>
</html>