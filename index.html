<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Viewer</title>
</head>
<body style="background-color:rgb(51, 51, 51);">

<!-- Adds COOP and COEP headers, see: https://github.com/gzuidhof/coi-serviceworker -->
<script src="coi-serviceworker.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js"></script>
<script type="module">
    import { createOffscreenRenderer, Config } from './js/src/offscreen_renderer.js';
    import { VolumeDataSourceConfig } from "./js/src/volume-data-source.js";

    // TODO: clean this up
    // can it do transfer functions?
    // maybe: https://github.com/tweakpane/plugin-essentials
    const settings = new Tweakpane.Pane({
        title: 'Settings',
        expanded: true,
    });

    // DATA SETTINGS
    const dataParams = {
        channel: 0,
    };
    const dataSettings = settings.addFolder({
        title: 'Data',
        expanded: true,
    });
    dataSettings
        .addInput(dataParams, 'channel', {min: 0, max: 0, step: 1})
        .on('change', console.log);

    // RENDER SETTINGS
    const renderParams = {
        stepSize: 5.0,
        threshold: 0.5,
        adjustForPadding: false,
        renderMode: 'grid_traversal',
        color: '#0000ff',
    };

    const renderSettings = settings.addFolder({
        title: 'Rendering',
        expanded: true,
    });
    const stepsSlider = renderSettings.addInput(
        renderParams, 'stepSize',
        {min: 0.5, max: 10.0, step: 0.2}
    );
    const thresholdSlider = renderSettings.addInput(
        renderParams, 'threshold',
        {min: 0.0, max: 1.0, step: 0.01}
    );
    const renderModeSelector = renderSettings.addInput(
        renderParams, 'renderMode',
        {
            options: {
                'Grid Traversal': 'grid_traversal',
                Direct: 'direct',
            }
        }
    );
    const colorPicker = renderSettings.addInput(renderParams, 'color');


    // EXPORT SETTINGS
    const exportSettingsButton = settings.addButton({
        title: 'Export Settings',
    });
    exportSettingsButton.on('click', function() {
        const preset = settings.exportPreset();
        console.log(preset);
    })

    async function start() {
        try {
            const offscreenRenderer = await createOffscreenRenderer(new Config({
                canvas: {
                    canvasId: 'canvas'
                },
                logging: 'debug',
                dataSource: new VolumeDataSourceConfig({
                    store: 'http://localhost:8005/',
                    path: 'bunny.zarr', //'stag_beetle.zarr',//'ome-zarr/m-128x128.ome.zarr/0',
                }, {})
            }));
            offscreenRenderer.run();

            // register UI event listeners for render settings
            const dispatchRenderSettingsChange = (e) => {
                offscreenRenderer.dispatchUIEvent(JSON.stringify({
                    type: 'rendersettings',
                    setting: e.presetKey,
                    value: e.value,
                }));
            };

            stepsSlider.on('change', dispatchRenderSettingsChange);
            renderModeSelector.on('change', dispatchRenderSettingsChange);
            thresholdSlider.on('change', dispatchRenderSettingsChange);
            colorPicker.on('change', dispatchRenderSettingsChange);

        } catch (e) {
            console.error(e);
        }
    }
    start();
</script>

<div>
    <canvas id="canvas" width="800" height="600"></canvas>
</div>

</body>
</html>